@using QL_TrungTamAnhNgu.Models;

@model QL_TrungTamAnhNgu.Models.NhomNguoiDung

@{
    ViewBag.Title = "SuaQuyen";
    Layout = "~/Views/Shared/_LayoutQuanTriVien.cshtml";
}

<h1 class="my-4 text-center h1">Chỉnh sửa phân quyền</h1>

<div class="container ">

    <form class="my-4 mx-3" method="post" id="group_form" action="/QuanTriVien/XuLySuaQuyen/?MaNhomND=@Html.DisplayFor(model => model.MaNhomND)">
        <!-- Group Name -->
        <div class="mb-4">
            <label for="id_name" class="form-label fw-bold">Tên nhóm <span class="text-danger">*</span></label>
            <input type="text" name="TenNhomND" class="form-control" id="id_name" maxlength="150" readonly value="@Model.TenNhomND">
        </div>

        <!-- Permissions -->
        <div class="mb-4">
            <label for="id_permissions_from" class="form-label fw-bold">Quyền</label>
            <div class="row">
                <!-- Available Permissions -->
                <div class="col-md-5">
                    <h5 class="my-2 fw-bold text-center">Quyền có sẵn</h5>
                    <input type="text" id="filter_from" class="form-control mb-2" placeholder="Tìm kiếm quyền có sẵn..." />
                    <select id="id_permissions_from" class="form-select" multiple size="10" name="permissions_old" style="max-width: 100%; overflow-x: auto; white-space: nowrap;">
                        @foreach (var item in TempData["role"] as List<fn_VaiTro_KhongThuocNNDResult> ?? new List<fn_VaiTro_KhongThuocNNDResult>())
                        {
                            <option value="@item.MaVaiTro">@item.TenVaiTro</option>
                        }
                    </select>
                </div>

                <!-- Actions -->
                <div class="col-md-2 d-flex flex-column align-items-center justify-content-center">
                    <button type="button" class="btn btn-primary mb-2" id="id_permissions_add_link">Chọn</button>
                    <button type="button" class="btn btn-secondary" id="id_permissions_remove_link">Bỏ chọn</button>
                </div>

                <!-- Chosen Permissions -->
                <div class="col-md-5">
                    <h5 class="my-2 fw-bold text-center">Quyền đã chọn</h5>
                    <input type="text" id="filter_to" class="form-control mb-2" placeholder="Tìm kiếm quyền đã chọn..." />
                    <select id="id_permissions_to" class="form-select" multiple size="10" name="permissions" style="max-width: 100%; overflow-x: auto; white-space: nowrap;">
                        @foreach (var item in TempData["roleNhomND"] as List<VaiTro_NhomNguoiDung> ?? new List<VaiTro_NhomNguoiDung>())
                        {
                            <option value="@item.MaVaiTro">@item.VaiTro.TenVaiTro</option>
                        }
                    </select>
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="d-flex justify-content-between btn-actions">
            <button type="button" class="btn btn-primary" id="saveButton">Lưu</button>
            <a href="#" class="btn btn-secondary">Quay lại</a>
        </div>
    </form>
</div>

<!-- Liên kết đến thư viện jQuery từ CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // Lọc các quyền trong "Quyền có sẵn"
    $('#filter_from').on('input', function () {
        var filter = $(this).val().toLowerCase();
        $('#id_permissions_from option').each(function () {
            var text = $(this).text().toLowerCase();
            $(this).toggle(text.indexOf(filter) > -1);
        });
    });

    // Lọc các quyền trong "Quyền đã chọn"
    $('#filter_to').on('input', function () {
        var filter = $(this).val().toLowerCase();
        $('#id_permissions_to option').each(function () {
            var text = $(this).text().toLowerCase();
            $(this).toggle(text.indexOf(filter) > -1);
        });
    });

    // Chuyển quyền từ "Quyền có sẵn" sang "Quyền đã chọn"
    document.getElementById("id_permissions_add_link").onclick = function () {
        var available = document.getElementById("id_permissions_from");
        var chosen = document.getElementById("id_permissions_to");

        // Di chuyển các quyền được chọn từ "Quyền có sẵn" sang "Quyền đã chọn"
        for (var i = available.options.length - 1; i >= 0; i--) {
            if (available.options[i].selected) {
                chosen.appendChild(available.options[i]);
            }
        }
    };

    // Chuyển quyền từ "Quyền đã chọn" về "Quyền có sẵn"
    document.getElementById("id_permissions_remove_link").onclick = function () {
        var chosen = document.getElementById("id_permissions_to");
        var available = document.getElementById("id_permissions_from");

        // Di chuyển các quyền được chọn từ "Quyền đã chọn" về "Quyền có sẵn"
        for (var i = chosen.options.length - 1; i >= 0; i--) {
            if (chosen.options[i].selected) {
                available.appendChild(chosen.options[i]);
            }
        }
    };

    // Lưu dữ liệu bằng AJAX khi nhấn nút "Lưu"
    document.getElementById("saveButton").onclick = function () {
        var newPermissions = [];
        var removedPermissions = [];

        // Lấy các quyền đã chọn
        var chosen = document.getElementById("id_permissions_to");
        for (var i = 0; i < chosen.options.length; i++) {
            if (chosen.options[i].selected) {
                newPermissions.push(chosen.options[i].value);
            }
        }

        // Lấy các quyền đã bỏ chọn
        var available = document.getElementById("id_permissions_from");
        for (var i = 0; i < available.options.length; i++) {
            if (available.options[i].selected) {
                removedPermissions.push(available.options[i].value);
            }
        }

        // Gửi yêu cầu AJAX
        $.ajax({
            url: '/QuanTriVien/XuLySuaNhomND', // Đảm bảo URL này trùng với đường dẫn action của bạn
            method: 'POST',
            data: {
                MaNhomND: '@Model.MaNhomND', // Truyền MaNhomND vào
                new_permissions: newPermissions.join(','), // Các quyền mới
                removed_permissions: removedPermissions.join(',') // Các quyền bị bỏ
            },
            success: function(response) {
                // Xử lý thành công
                alert('Dữ liệu đã được cập nhật!');
                // window.location.href = "/QuanTriVien/Index"; // Nếu cần chuyển hướng
            },
            error: function(xhr, status, error) {
                // Xử lý lỗi
                alert('Có lỗi xảy ra! Vui lòng thử lại.');
            }
        });
    };
</script>
