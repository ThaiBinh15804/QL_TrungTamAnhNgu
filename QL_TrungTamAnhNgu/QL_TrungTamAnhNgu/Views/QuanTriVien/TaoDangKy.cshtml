@using QL_TrungTamAnhNgu.Models;

@model List<QL_TrungTamAnhNgu.Models.KhoaHoc>

@{
    ViewBag.Title = "TaoDangKy";
    Layout = "~/Views/Shared/_LayoutQuanTriVien.cshtml";
}

<div class="container mt-5">
    <h2 class="mb-4 fw-bold h2 text-center">Tạo Đăng Ký</h2>

    <form id="dangKyForm" method="post">
        <!-- Chọn Khóa Học -->
        <div class="form-group mb-3">
            <label class="mb-2" for="khoaHoc">Chọn Khóa Học:</label>
            <select id="khoaHoc" class="form-control" name="KhoaHocId">
                <option value="">-- Chọn Khóa Học --</option>
                @foreach (var khoaHoc in Model)
                {
                    <option value="@khoaHoc.MaKhoaHoc">@khoaHoc.TenKhoaHoc</option>
                }
            </select>
            @*@{
                    string MaKH = null;
                }*@
        </div>

        <!-- Chọn Lớp Học -->
        <div class="form-group mb-3">
            <label class="mb-2" for="lopHoc">Chọn Lớp Học:</label>
            <select id="lopHoc" class="form-control" name="LopHocId" disabled>
                <option value="">-- Chọn Lớp Học --</option>
                @*@{

                        foreach (var i in Model.FirstOrDefault(t => t.MaKhoaHoc == MaKH).LopHocs.ToList())
                        {
                            <option value="@i.MaLop">@i.TenLop</option>
                        }
                    }*@
            </select>
        </div>

        <!-- Chọn Giảm Giá -->
        <div class="form-group mb-3">
            <label class="mb-2" for="giamGia">Chọn Giảm Giá:</label>
            <select id="giamGia" class="form-control" name="GiamGiaId" disabled>
                <option value="">-- Chọn Giảm Giá --</option>
            </select>
        </div>


        <!-- Nút Thêm Đăng Ký -->
        <button id="btnThemDangKy" type="button" class="btn btn-primary btn-block">Thêm Đăng Ký</button>
    </form>

    <hr class="my-4">

    <!-- Danh sách các Đăng Ký hiện tại -->
    <h4 class="mb-3">Danh Sách Đăng Ký</h4>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>STT</th>
                <th>Khóa Học</th>
                <th>Lớp Học</th>
                <th>Giảm Giá</th>
                <th>Tiền Gốc</th>
                <th>Giảm Giá</th>
                <th>Thực Trả</th>
            </tr>
        </thead>
        <tbody>
            @{
                var tt = Session["ThanhToan"] as ThanhToan;
                if (tt != null)
                {
                    var danhSachDangKy = tt.DangKies.ToList();
                    int index = 1;
                    foreach (DangKy dangKy in danhSachDangKy)
                    {
                        <tr>
                            <td>@index</td>
                            <td>@dangKy.LopHoc.KhoaHoc.TenKhoaHoc</td>
                            <td>@dangKy.LopHoc.TenLop</td>
                            <td>@dangKy.GiamGia.TiLeGiam %</td>
                            <td>@dangKy.SoTien VND</td>
                            <td>@dangKy.ThucTra VND</td>
                        </tr>
                        index++;
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center">Chưa có đăng ký nào.</td>
                    </tr>
                }
            }
        </tbody>
    </table>

    <p><hr /></p>

    <!-- Hiển thị Thông Tin Thanh Toán -->
    <div class="form-group mb-4">
        <label class="mb-2">Thông Tin Thanh Toán:</label>
        <div>
            <p class="mb-3 fw-bold"><strong>Tiền Gốc:</strong> <span id="tienGoc">0</span> VND</p>
            <p class="mb-3 fw-bold"><strong>Tiền Giảm Giá:</strong> <span id="tienGiam">0</span> VND</p>
            <p class="mb-3 fw-bold"><strong>Thực Trả:</strong> <span id="thucTra">0</span> VND</p>
        </div>
    </div>

    <!-- Nút Thanh Toán và Hủy -->
    <div class="my-3">
        <a href="/QuanTriVien/XacNhanThanhToan" id="btnThanhToan" class="btn mx-3 my-2 btn-success">Thanh Toán</a>
        <a href="/QuanTriVien/HuyThanhToan" id="btnHuyThanhToan" class="btn mx-3 my-2 btn-danger">Huỷ thanh toán</a>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        // Khi chọn Khóa Học
        $('#khoaHoc').change(function () {
            const khoaHocId = $(this).val(); // Lấy ID khóa học được chọn

            if (khoaHocId) {
                // AJAX lấy danh sách Lớp Học
                console.log("Gửi về ajax");
                $.ajax({
                    url: '/QuanTriVien/LayDanhSachLopHoc', // Controller & Action
                    type: 'POST',
                    data: { MaKH: khoaHocId },
                    success: function (response) {
                        console.log("Lop hoc" + response);
                        $('#lopHoc').html('<option value="">-- Chọn Lớp Học --</option>'); // Reset danh sách lớp học
                        $.each(response.lh, function (index, item) {
                            console.log("Item Lop Hoc:", item); // Kiểm tra từng lớp học
                            $('#lopHoc').append('<option value="' + item.MaLop + '">' + item.TenLop + '</option>');
                        });
                        $('#lopHoc').prop('disabled', false); // Mở khóa combobox Lớp Học
                    },
                    error: function (xhr, status, error) {
                        console.log('Error:', status, error);
                        console.log(xhr.responseText); // Lỗi trả về từ server
                        alert('Có lỗi xảy ra! Vui lòng thử lại.');
                    }

                });

                console.log("Gửi về ajax");
                // AJAX lấy danh sách Giảm Giá
                $.ajax({
                    url: '/QuanTriVien/LayDanhSachGiamGia', // Controller & Action
                    type: 'POST',
                    data: { MaKH: khoaHocId },
                    success: function (response) {
                        console.log("Giam gia" + response);
                        $('#giamGia').html('<option value="">-- Chọn Giảm Giá --</option>'); // Reset danh sách giảm giá
                        $.each(response.gg, function (index, item) {
                            $('#giamGia').append('<option value="' + item.MaGiamGia + '">' + item.TenGiamGia + ' - ' + item.TiLeGiam + '%</option>');
                        });
                        $('#giamGia').prop('disabled', false); // Mở khóa combobox Giảm Giá
                    },
                    error: function (xhr, status, error) {
                        console.log('Error:', status, error);
                        console.log(xhr.responseText); // Lỗi trả về từ server
                        alert('Có lỗi xảy ra! Vui lòng thử lại.');
                    }
                });
            } else {
                // Nếu không chọn khóa học nào, reset danh sách và disable
                $('#lopHoc').html('<option value="">-- Chọn Lớp Học --</option>').prop('disabled', true);
                $('#giamGia').html('<option value="">-- Chọn Giảm Giá --</option>').prop('disabled', true);
            }
        });

        // Khi nhấn nút Thêm Đăng Ký
        $('#btnThemDangKy').click(function () {
            
            const formData = {
                LopHocId: $('#lopHoc').val(),
                GiamGiaId: $('#giamGia').val()
            };

            if (!formData.LopHocId) {
                alert('Vui lòng chọn lớp Học!');
                return;
            }

            // AJAX thêm Đăng Ký
            $.ajax({
                url: '/QuanTriVien/ThemDangKy', // Controller & Action
                type: 'POST',
                data: formData,
                success: function (response) {
                    if (response.success) {
                        alert('Thêm đăng ký thành công!');
                        // Biến tổng giá trị
                        let tienGocTong = 0;
                        let tienGiamTong = 0;
                        let thucTraTong = 0;
                        // Cập nhật danh sách Đăng Ký trong bảng
                        $('tbody').html('');
                        $.each(response.danhSachDangKy, function (index, item) {

                            // Cộng dồn giá trị
                            tienGocTong += item.SoTien;
                            tienGiamTong += item.Giam; // Số tiền giảm giá
                            thucTraTong += item.ThucTra;

                            $('tbody').append(
                                '<tr>' +
                                    '<td>' + item.STT + '</td>' +  // Sử dụng STT từ response
                                    '<td>' + item.KhoaHoc + '</td>' +  // Tên Khóa Học
                                    '<td>' + item.LopHoc + '</td>' +  // Tên Lớp Học
                                    '<td>' + item.GiamGia + '%</td>' +  // Tỉ lệ Giảm Giá
                                    '<td>' + item.SoTien + ' VND</td>' +  // Số Tiền
                                    '<td>' + item.Giam + ' VND</td>' +  // Số tien giam
                                    '<td>' + item.ThucTra + ' VND</td>' +  // Thực Trả
                                '</tr>'
                            );
                        });

                        // Cập nhật thông tin thanh toán
                        $('#tienGoc').text(tienGocTong.toLocaleString());
                        $('#tienGiam').text(tienGiamTong.toLocaleString());
                        $('#thucTra').text(thucTraTong.toLocaleString());

                        // Reset lại các select
                        $('#khoaHoc').val('').prop('disabled', false); // Đặt lại lựa chọn khóa học và mở khóa
                        $('#lopHoc').val('').prop('disabled', true); // Đặt lại lớp học và khóa lại
                        $('#giamGia').val('').prop('disabled', true); // Đặt lại giảm giá và khóa lại
                    } else {
                        alert('Có lỗi xảy ra. Vui lòng thử lại!');
                    }
                },
                error: function (xhr, status, error) {
                    console.log('Error:', status, error);
                    console.log(xhr.responseText); // Lỗi trả về từ server
                    alert('Có lỗi xảy ra! Vui lòng thử lại.');
                }
            });
        });
    });
</script>
